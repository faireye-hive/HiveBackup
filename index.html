<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Hive → ZIP (posts + imagens)</title>
  <style>
    :root{
      --bg:#020617;--card:#0f172a;--primary:#38bdf8;--text:#e5e7eb;--muted:#94a3b8;--ok:#22c55e
    }
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:radial-gradient(circle at top,#020617,#000);color:var(--text);min-height:100vh;margin:0;display:flex;align-items:center;justify-content:center}
    .card{background:var(--card);width:100%;max-width:820px;padding:28px;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
    h1{margin-top:0;color:var(--primary)}
    p{color:var(--muted)}
    .controls{display:flex;gap:10px;margin:20px 0}
    input{flex:1;padding:12px;font-size:16px;border-radius:8px;border:none;outline:none}
    button{padding:12px 18px;font-size:16px;border-radius:8px;border:none;background:var(--primary);font-weight:bold;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .progress{margin:20px 0}
    .bar{height:10px;background:#020617;border-radius:6px;overflow:hidden}
    .bar>div{height:100%;width:0%;background:linear-gradient(90deg,var(--primary),#60a5fa);transition:width .25s}
    .status{margin-top:10px;font-size:14px;color:var(--muted)}
    .log{margin-top:20px;background:#020617;padding:12px;border-radius:8px;max-height:260px;overflow-y:auto;font-size:13px;line-height:1.4}
    .log .ok{color:var(--ok)}
  </style>
</head>
<body>
  <div class="card">
    <h1>Hive → ZIP</h1>
    <p>Exports <b>all original posts</b> from Hive (excluding comments/reblogs). For each post: creates a folder with <b>PDF or TXT</b> + <b>images/</b> subfolder with all images downloaded via <code>images.hive.blog</code>. Finally, generates a <b>ZIP</b> file.</p>
    <div class="controls">
      <input id="username" placeholder="username Hive (sem @)" />
      <button id="btn" onclick="exportar()">Export ZIP</button>
    </div>

    <div class="progress">
      <div class="bar"><div id="bar"></div></div>
      <div class="status" id="status">Waiting…</div>
    </div>

    <div class="log" id="log"></div>
  </div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const barEl = document.getElementById('bar');
    const btn = document.getElementById('btn');

    const log = (msg, ok=false)=>{const d=document.createElement('div');if(ok)d.className='ok';d.textContent=msg;logEl.appendChild(d);logEl.scrollTop=logEl.scrollHeight};
    const setStatus=(t,p=null)=>{statusEl.textContent=t;if(p!==null)barEl.style.width=p+'%'};

    async function hiveCall(method, params){
      const res = await fetch('https://api.hive.blog',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({jsonrpc:'2.0',method,params,id:1})
      });
      return res.json();
    }

    async function buscarPosts(username){
      let posts=[];let start_author=null,start_permlink=null;const seen=new Set();let page=0;
      while(true){
        page++; setStatus(`Buscando posts… página ${page}`);
        const q={tag:username,limit:20};
        if(start_author){q.start_author=start_author;q.start_permlink=start_permlink}
        const r=await hiveCall('condenser_api.get_discussions_by_blog',[q]);
        const arr=r.result||[]; if(!arr.length) break;
        for(const p of arr){ if(p.author===username && p.parent_author==='' && !seen.has(p.permlink)){ seen.add(p.permlink); posts.push(p);} }
        log(`Página ${page}: ${arr.length} itens (${posts.length} válidos)`);
        const last=arr[arr.length-1]; start_author=last.author; start_permlink=last.permlink;
        if(arr.length<20) break;
      }
      return posts.reverse();
    }

    const formatDate = d => new Date(d+'Z').toLocaleDateString('pt-BR');

    function safeName(s){ return s.replace(/[^a-z0-9-_]+/gi,'_').replace(/_+/g,'_').replace(/^_|_$/g,'').toLowerCase(); }

    function extractImageUrls(body){
      const urls=new Set();
      // Markdown ![alt](url)
      const md=/!\[[^\]]*\]\(([^)]+)\)/g; let m;
      while((m=md.exec(body))) urls.add(m[1]);
      // HTML <img src="url">
      const html=/<img[^>]+src=["']([^"']+)["']/gi;
      while((m=html.exec(body))) urls.add(m[1]);
      return [...urls];
    }

    function proxify(url){
      if(url.startsWith('http')) return 'https://images.hive.blog/0x0/'+url;
      return url;
    }

    async function fetchBinary(url){
      const r=await fetch(url,{mode:'cors'});
      return await r.arrayBuffer();
    }

    async function exportar(){
      const username=document.getElementById('username').value.trim();
      if(!username) return alert('Informe o username');
      btn.disabled=true; logEl.innerHTML=''; barEl.style.width='0%';
      setStatus('Iniciando…',5); log(`Usuário: @${username}`);

      const posts=await buscarPosts(username);
      if(!posts.length){ alert('Nenhum post encontrado'); btn.disabled=false; return; }
      setStatus(`Preparando ZIP (${posts.length} posts)…`,25);

      const zip=new JSZip();
      const root=zip.folder(`${username}_hive_posts`);

      const { jsPDF } = window.jspdf;

      for(let i=0;i<posts.length;i++){
        const p=posts[i];
        setStatus(`Processando ${i+1}/${posts.length}`,25 + (i/posts.length)*60);

        const title=p.title||'(sem titulo)';
        const date=formatDate(p.created);
        let tags=''; try{ tags=JSON.parse(p.json_metadata).tags?.join(', ')||'';}catch{}

        const slug=safeName(`${p.created.slice(0,10)}_${p.permlink}`);
        const postDir=root.folder(slug);
        const imgDir=postDir.folder('imagens');

        // TXT
        const header=`${title}\nData: ${date}${tags?`\nTags: ${tags}`:''}\n\n`;
        postDir.file('post.txt', header + p.body);

        // PDF
        const pdf=new jsPDF(); let y=10;
        pdf.setFontSize(14); pdf.text(title,10,y); y+=7;
        pdf.setFontSize(9); pdf.text(`Data: ${date}`,10,y); y+=5;
        if(tags){ pdf.text(`Tags: ${tags}`,10,y); y+=5; }
        y+=3; pdf.setFontSize(10);
        const lines=pdf.splitTextToSize(p.body.replace(/\s+/g,' '),190);
        for(const line of lines){ if(y>280){ pdf.addPage(); y=10; } pdf.text(line,10,y); y+=5; }
        postDir.file('post.pdf', pdf.output('arraybuffer'));

        // IMAGENS
        const imgs=extractImageUrls(p.body);
        for(let j=0;j<imgs.length;j++){
          const raw=imgs[j];
          const url=proxify(raw);
          try{
            const bin=await fetchBinary(url);
            const ext=(raw.split('.').pop()||'jpg').split('?')[0].slice(0,4);
            imgDir.file(`img_${j+1}.${ext}`, bin);
            log(`Imagem ${j+1}/${imgs.length} (${slug})`);
          }catch(e){ log(`Falha ao baixar imagem: ${raw}`); }
        }
      }

      setStatus('Compacting…',90);
      const blob=await zip.generateAsync({type:'blob'}, m=>setStatus(`Compacting… ${Math.floor(m.percent)}%`,90 + m.percent*0.1));
      saveAs(blob, `${username}_hive_posts.zip`);
      setStatus('Completed ✔',100); log('ZIP generated successfully!',true); btn.disabled=false;
    }
  </script>
</body>
</html>
