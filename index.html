<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HiveBackup</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
body {
  background: #0f172a;
  color: #e5e7eb;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
}
header {
  padding: 20px;
  background: #020617;
  text-align: center;
  font-size: 1.5em;
  font-weight: bold;
}
main {
  max-width: 900px;
  margin: auto;
  padding: 20px;
}
input, button {
  padding: 10px;
  font-size: 1em;
}
input {
  width: 250px;
}
button {
  background: #2563eb;
  color: white;
  border: none;
  cursor: pointer;
}
button:disabled {
  opacity: 0.5;
}
.progress {
  height: 10px;
  background: #1e293b;
  margin: 15px 0;
  border-radius: 4px;
}
.progress div {
  height: 100%;
  background: #22c55e;
  width: 0%;
  border-radius: 4px;
}
#log {
  background: #020617;
  padding: 12px;
  height: 320px;
  overflow-y: auto;
  font-family: monospace;
  font-size: 0.85em;
  border-radius: 6px;
}
</style>
</head>

<body>

<header>HiveBackup ‚Äî Export & Archive Your Hive Content</header>

<main>
  <input id="user" placeholder="Hive username">
  <button onclick="startBackup()">Start Backup</button>

  <div class="progress"><div id="bar"></div></div>
  <div id="log"></div>
</main>

<script>
const logBox = document.getElementById("log");
const bar = document.getElementById("bar");

function log(msg) {
  logBox.innerHTML += msg + "<br>";
  logBox.scrollTop = logBox.scrollHeight;
}

function setProgress(p) {
  bar.style.width = p + "%";
}

// ---------- HIVE RPC ----------
async function hiveCall(method, params) {
  const res = await fetch("https://api.hive.blog", {
    method: "POST",
    body: JSON.stringify({
      jsonrpc: "2.0",
      method,
      params,
      id: 1
    })
  });
  return res.json();
}

// ---------- HELPERS ----------
function isReblog(post) {
  return post.reblogged_by?.length > 0 || post.body === "";
}

function slugify(text) {
  return text
    .toLowerCase()
    .replace(/[^\w]+/g, "-")
    .replace(/^-+|-+$/g, "");
}

function extractImages(markdown) {
  const urls = [];
  const mdImg = /!\[.*?\]\((.*?)\)/g;
  const htmlImg = /<img[^>]+src="([^">]+)"/g;

  let match;
  while ((match = mdImg.exec(markdown))) urls.push(match[1]);
  while ((match = htmlImg.exec(markdown))) urls.push(match[1]);

  return [...new Set(urls)];
}

function proxify(url) {
  return "https://images.hive.blog/0x0/" + url.replace(/^https?:\/\//, "");
}

async function fetchBinary(url) {
  const r = await fetch(url);
  return r.arrayBuffer();
}

// ---------- MAIN ----------
async function startBackup() {
  const username = document.getElementById("user").value.trim();
  if (!username) return;

  logBox.innerHTML = "";
  setProgress(0);

  log(`üîç Fetching posts from @${username}...`);

  const zip = new JSZip();
  let startPermlink = null;
  const posts = [];

  // Recursive fetch
  while (true) {
    const data = await hiveCall(
      "condenser_api.get_discussions_by_blog",
      [{
        tag: username,
        limit: 20,
        start_permlink: startPermlink
      }]
    );

    if (!data.result || data.result.length === 0) break;

    for (const post of data.result) {
      if (!isReblog(post)) posts.push(post);
    }

    startPermlink = data.result[data.result.length - 1].permlink;
    log(`üìÑ Collected ${posts.length} posts so far...`);
  }

  log(`‚úÖ Total posts: ${posts.length}`);

  let completed = 0;

  for (const post of posts) {
    const slug = slugify(post.title || post.permlink);
    log(`üì¶ Processing: ${slug}`);

    const postFolder = zip.folder(slug);
    const imgFolder = postFolder.folder("images");

    // Post content
    const content =
`Title: ${post.title}
Author: @${post.author}
Date: ${post.created}
Tags: ${(post.json_metadata?.tags || []).join(", ")}

${post.body}`;

    postFolder.file("post.txt", content);

    // Images (parallel with limit)
    const images = extractImages(post.body);
    const CONCURRENCY = 5;

    for (let i = 0; i < images.length; i += CONCURRENCY) {
      const batch = images.slice(i, i + CONCURRENCY);

      const results = await Promise.allSettled(
        batch.map(img => fetchBinary(proxify(img)))
      );

      results.forEach((res, idx) => {
        if (res.status === "fulfilled") {
          imgFolder.file(`img_${i + idx + 1}.jpg`, res.value);
        }
      });
    }

    completed++;
    setProgress(Math.round((completed / posts.length) * 100));
  }

  log("üì¶ Creating ZIP archive...");
  const blob = await zip.generateAsync({ type: "blob" });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `HiveBackup_${username}.zip`;
  a.click();

  log("üéâ Backup completed successfully!");
}
</script>

</body>
</html>
