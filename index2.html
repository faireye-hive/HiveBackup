<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Hive → PDF Exporter</title>
  <style>
    :root {
      --bg: #020617;
      --card: #0f172a;
      --primary: #38bdf8;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --ok: #22c55e;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #020617, #000);
      color: var(--text);
      min-height: 100vh;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card {
      background: var(--card);
      width: 100%;
      max-width: 720px;
      padding: 28px;
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
    }

    h1 {
      margin-top: 0;
      color: var(--primary);
    }

    p {
      color: var(--muted);
    }

    .controls {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }

    input {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      outline: none;
    }

    button {
      padding: 12px 18px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      font-weight: bold;
      cursor: pointer;
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .progress {
      margin: 20px 0;
    }

    .bar {
      height: 10px;
      background: #020617;
      border-radius: 6px;
      overflow: hidden;
    }

    .bar > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary), #60a5fa);
      transition: width .3s;
    }

    .status {
      margin-top: 10px;
      font-size: 14px;
      color: var(--muted);
    }

    .log {
      margin-top: 20px;
      background: #020617;
      padding: 12px;
      border-radius: 8px;
      max-height: 220px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.4;
    }

    .log .ok { color: var(--ok); }
  </style>
</head>
<body>
  <div class="card">
    <h1>Hive → PDF</h1>
    <p>Exporta <b>todos os seus posts autorais</b> do Hive (sem comentários e reblogs) para um único PDF.</p>

    <div class="controls">
      <input id="username" placeholder="username Hive (sem @)" />
      <button id="btn" onclick="exportar()">Exportar</button>
    </div>

    <div class="progress">
      <div class="bar"><div id="bar"></div></div>
      <div class="status" id="status">Aguardando…</div>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const barEl = document.getElementById('bar');
    const btn = document.getElementById('btn');

    const log = (msg, ok = false) => {
      const div = document.createElement('div');
      if (ok) div.className = 'ok';
      div.textContent = msg;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    };

    const setStatus = (text, pct = null) => {
      statusEl.textContent = text;
      if (pct !== null) barEl.style.width = pct + '%';
    };

    async function hiveCall(method, params) {
      const res = await fetch('https://api.hive.blog', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ jsonrpc: '2.0', method, params, id: 1 })
      });
      return res.json();
    }

    async function buscarPosts(username) {
      let posts = [];
      let start_author = null;
      let start_permlink = null;
      const seen = new Set();
      let page = 0;

      while (true) {
        page++;
        setStatus(`Buscando posts… página ${page}`);

        const query = { tag: username, limit: 20 };
        if (start_author) {
          query.start_author = start_author;
          query.start_permlink = start_permlink;
        }

        const r = await hiveCall('condenser_api.get_discussions_by_blog', [query]);
        const result = r.result || [];
        if (!result.length) break;

        for (const post of result) {
          if (post.author === username && post.parent_author === '' && !seen.has(post.permlink)) {
            seen.add(post.permlink);
            posts.push(post);
          }
        }

        log(`Página ${page}: ${result.length} itens (${posts.length} válidos)`);

        const last = result[result.length - 1];
        start_author = last.author;
        start_permlink = last.permlink;

        if (result.length < 20) break;
      }

      return posts.reverse();
    }

    function formatDate(d) {
      return new Date(d + 'Z').toLocaleDateString('pt-BR');
    }

    async function exportar() {
      const username = document.getElementById('username').value.trim();
      if (!username) return alert('Informe o username');

      btn.disabled = true;
      logEl.innerHTML = '';
      barEl.style.width = '0%';

      setStatus('Iniciando…', 5);
      log(`Usuário: @${username}`);

      const posts = await buscarPosts(username);
      setStatus(`Gerando PDF (${posts.length} posts)…`, 40);

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      let y = 10;

      posts.forEach((p, i) => {
        setStatus(`Renderizando post ${i + 1}/${posts.length}`, 40 + (i / posts.length) * 50);

        const title = p.title || '(sem título)';
        const date = formatDate(p.created);
        let tags = '';
        try { tags = JSON.parse(p.json_metadata).tags?.join(', ') || ''; } catch {}

        pdf.setFontSize(14);
        pdf.text(title, 10, y); y += 7;
        pdf.setFontSize(9);
        pdf.text(`Data: ${date}`, 10, y); y += 5;
        if (tags) { pdf.text(`Tags: ${tags}`, 10, y); y += 5; }

        y += 3;
        pdf.setFontSize(10);
        const lines = pdf.splitTextToSize(p.body.replace(/\s+/g, ' '), 190);
        for (const line of lines) {
          if (y > 280) { pdf.addPage(); y = 10; }
          pdf.text(line, 10, y); y += 5;
        }

        if (i < posts.length - 1) { pdf.addPage(); y = 10; }
      });

      setStatus('Finalizando…', 95);
      pdf.save(`${username}_hive_posts.pdf`);

      setStatus('Concluído ✔', 100);
      log('PDF gerado com sucesso!', true);
      btn.disabled = false;
    }
  </script>
</body>
</html>
